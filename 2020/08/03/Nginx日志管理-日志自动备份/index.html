<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="何必那么认真"><title>Nginx日志管理 &amp; 日志自动备份 | Sean's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Nginx日志管理 &amp; 日志自动备份</h1><a id="logo" href="/.">Sean's Blog</a><p class="description">why so serious ?</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Nginx日志管理 &amp; 日志自动备份</h1><div class="post-meta">2020-08-03<span> | </span><span class="category"><a href="/category/Nginx/">Nginx</a></span></div><div class="post-content"><ul>
<li><p>Nginx 是一个非常轻量的 Web服务器，体积小、性能高、速度快等诸多优点。但不足的是也存在缺点，比如其产生的访问日志文件一直就是一个，不会自动地进行切割，如果访问量很大的话，将 导致日志文件容量非常大，不便于管理。当然了，我们也不希望看到这么庞大的一个访问日志文件，那需要手动对这个文件进行切割。</p>
</li>
<li><p>在 Linux 平台上 Shell 脚本丰富，使用 Shell 脚本加 crontab 命令能非常方便地进行切割</p>
</li>
<li><p>由于 Nginx 的日志都是写在一个文件当中的，因此，我们需要每天零点将前一天的日志存为另外一个文件，这里我们就将 Nginx 位于 logs 目录中的 access.log 存为 access_[yyyy-MM-dd].log 的文件。其实 logs 目录中还有个 error.log 的错误日志文件，这个文件也需要每天切割一个，在这里就说 access.log 了，error.log 的切割方法类似。</p>
</li>
<li><p>在 Linux 平台上进行切割，需要使用 date 命令以获得昨天的日期、使用 kill 命令向 Nginx 进程发送重新打开日志文件的信号，以及 crontab 设置执行任务周期。</p>
</li>
</ul>
<h2 id="Nginx日志描述"><a href="#Nginx日志描述" class="headerlink" title="Nginx日志描述"></a>Nginx日志描述</h2><ul>
<li>通过访问日志, 可以得到用户地域来源 / 跳转来源 / 使用终端 / 某个URL访问量等相关信息 ;</li>
<li>通过错误日志, 可以得到系统某个服务或Server的性能瓶颈等</li>
<li>将日志好好利用, 可以得到很多有价值的信息</li>
</ul>
<h2 id="Nginx日志格式"><a href="#Nginx日志格式" class="headerlink" title="Nginx日志格式"></a>Nginx日志格式</h2><h3 id="nginx-conf配置文件"><a href="#nginx-conf配置文件" class="headerlink" title="nginx.conf配置文件"></a>nginx.conf配置文件</h3><ul>
<li>通过查看Ngxin配置文件中的 <code>access.log</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#这说明, 该Server, 它的访问日志的文件时 Logs&#x2F;host.access.log, 默认使用的格式 &#39;main&#39; 格式</span><br><span class="line">access_log logs&#x2F;host.access.log main;</span><br></pre></td></tr></table></figure></li>
<li>除了<code>main</code>格式, 还可以自定义其他格式</li>
<li><code>main</code>的主要格式<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#main格式是我们定义好的一种日志格式, 并起个名字, 便于引用, 以下例子main类型的日志, 记录的remote_addr ... http_x_forwarder.for等选项</span><br><span class="line">log_format main &#39;$remote_addr - $remote_user [$time_local] $request $status $body_bytes_sent $http_referer $http_user_agent $http_x_forwarder_for&#39;;</span><br></pre></td></tr></table></figure></li>
<li>如默认的main日志格式, 记录以下几项:<ul>
<li>远程IP-远程用户/用户时间 请求方式 (如GET/POST) 请求body长度 referer来源信息</li>
<li>http_user_agent 用户代理/蜘蛛, 被转发的请求的原始IP</li>
<li>http_x_forwarder_for; 在经过代理时, 代理把你的本来的IP加在此头信息中, 传输你的原始IP</li>
<li>log_format 参数明细表 : <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$remote_addr    #客户端的IP地址(代理服务器, 显示代理服务IP)</span><br><span class="line">$remote_user    #用于记录远程客户端的用户名称(一般为&#39;-&#39;)</span><br><span class="line">$time_local    #用于记录访问时间和时区</span><br><span class="line">$request    #用于请求记录的URL以及请求方法</span><br><span class="line">$status    #响应状态码, 例如: 200成功 &#x2F; 404页面找不到等</span><br><span class="line">$body_bytes_sent    #给客户端发送的文件主题内容字节数</span><br><span class="line">$http_user_agent    #用户所使用的代理(一般为浏览器)</span><br><span class="line">$http_x_forwarder_for    #可以记录客户端IP, 通过代理服务器来记录客户端的IP地址</span><br><span class="line">$http_referer    #可以记录用户是从哪个链接访问过来的</span><br></pre></td></tr></table></figure></li>
<li>Nginx允许针对不同的Server做不同的log, (有的Web服务器不支持)</li>
</ul>
</li>
</ul>
<h3 id="实际配置信息"><a href="#实际配置信息" class="headerlink" title="实际配置信息"></a>实际配置信息</h3><ul>
<li>位置(两种方式)<ul>
<li>http内, server外</li>
<li>server内, location下 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#配置后, 重启即可</span><br><span class="line">access_log logs&#x2F;host.access.log main;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="Nginx日志分隔"><a href="#Nginx日志分隔" class="headerlink" title="Nginx日志分隔"></a>Nginx日志分隔</h3><ul>
<li>Nginx的日志文件没有rotate功能, 编写每天生成一个日志, 我们可以写一个Nginx日志分隔脚本来自动切割日志文件<ul>
<li>第一步需要对日志文件重命名, 一般日志文件的命名根据时间日期进行命名</li>
<li>第二步向Nginx朱进程发送USR1信号, Nginx主进程接到信号后会从配置文件中读取日志文件名称, 重新打开日志文件(以配置文件中的日志名称命名), 并以工作进程的用户作为日志文件的所有者, 重新打开日志文件后, Nginx主进程会关闭重命名的日志文件并通知进程使用新打开的日志文件, 工作进程立即打开新的日志文件并关闭重命名的日志文件</li>
</ul>
</li>
</ul>
<ol>
<li>以日期命名日志文件名 :</li>
</ol>
<ul>
<li>查看时间/日期 : date命令 </li>
<li>时间/日期格式化命令: date -d yesterday +%Y%m%d</li>
</ul>
<ol start="2">
<li>编写一个shell脚本, 自动切割日志文件</li>
</ol>
<ul>
<li>创建一个data文件夹, 存放日志文件<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir data</span><br><span class="line">cd data</span><br></pre></td></tr></table></figure></li>
<li>编写一个shell脚本, runlog.sh — 脚本示例 ( 多选一 )<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">#设置基路径</span><br><span class="line">BASE_DIR&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx</span><br><span class="line">#要切割备份的日志文件名</span><br><span class="line">BASE_FILE_NAME&#x3D;access.log</span><br><span class="line">#日志路径</span><br><span class="line">LOG_PATH&#x3D;$BASE_DIR&#x2F;logs</span><br><span class="line">#日志切割后备份路径</span><br><span class="line">BAK_PATH&#x3D;$BASE_DIR&#x2F;back_up_logs</span><br><span class="line">#切割日志文件</span><br><span class="line">LOG_FILE&#x3D;$LOG_PATH&#x2F;$BASE_FILE_NAME</span><br><span class="line">#获取时间</span><br><span class="line">BAK_TIME&#x3D;&#96;&#x2F;bin&#x2F;date -d yesterday +%Y%m%d%H%M&#96;  &#x2F;&#x2F;为了测试效果，以分钟为单位，故每分钟备份一次，具体按照实际需求设置</span><br><span class="line">#备份文件</span><br><span class="line">BAK_FILE&#x3D;$BAK_PATH&#x2F;$BAK_TIME-$BASE_FILE_NAME</span><br><span class="line">echo $BAK_FILE</span><br><span class="line">#关闭nginx</span><br><span class="line">$BASE_DIR&#x2F;sbin&#x2F;nginx -s stop</span><br><span class="line">#移动切割文件</span><br><span class="line">mv $LOG_FILE $BAK_FILE</span><br><span class="line">#启动nginx</span><br><span class="line">$BASE_DIR&#x2F;sbin&#x2F;nginx</span><br></pre></td></tr></table></figure></li>
<li>编写一个shell脚本, runlog.sh — 脚本示例 ( 多选一 )<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">LOGS_PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs</span><br><span class="line">YESTERDAY&#x3D;$(date -d &quot;yesterday&quot; +%Y-%m-%d)</span><br><span class="line">mv $&#123;LOGS_PATH&#125;&#x2F;sdk_acc.log $&#123;LOGS_PATH&#125;&#x2F;sdk_acc_$&#123;YESTERDAY&#125;.log</span><br><span class="line">mv $&#123;LOGS_PATH&#125;&#x2F;sell_acc.log $&#123;LOGS_PATH&#125;&#x2F;sell_acc_$&#123;YESTERDAY&#125;.log</span><br><span class="line">kill -USR1 $(cat &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;nginx.pid)       # 向 Nginx 主进程发送 USR1 信号。USR1 信号是重新打开日志文件</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="3">
<li>Linux定时任务, 旨在执行 shell 脚本</li>
</ol>
<ul>
<li><p>命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#编辑定时任务</span><br><span class="line">crontab -e</span><br><span class="line"></span><br><span class="line">#输入定时设置, 例举一小时执行一次 (cron表达式)</span><br><span class="line">#每小时的第59分钟执行该shell脚本进行日志切割备份</span><br><span class="line">59 *&#x2F;1 * * * sh &#39;shell脚本位置&#39;</span><br><span class="line"></span><br><span class="line">#保存退出后, 自动开始执行</span><br></pre></td></tr></table></figure>
</li>
<li><p>脚本授权</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 脚本授权</span><br><span class="line">chmod 755 log.sh</span><br><span class="line"></span><br><span class="line"># 创建定时任务调度,并执行(保存退出即可自动开始执行定时任务)</span><br><span class="line"># 执行该命令设置定时任务配置</span><br><span class="line">crontab -e</span><br><span class="line"># 添加如下配置,保存退出</span><br><span class="line">*&#x2F;1 * * * * sh &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;log.sh</span><br><span class="line"></span><br><span class="line">#关闭定时任务</span><br><span class="line">crontab -l #查看所有定时任务</span><br><span class="line">crontab -r #删除所有定时任务</span><br></pre></td></tr></table></figure>

<ul>
<li>cron 表达式参考 <a href="https://crontab.guru/" target="_blank" rel="noopener">点我点我</a></li>
</ul>
<h2 id="crontab"><a href="#crontab" class="headerlink" title="crontab"></a>crontab</h2><blockquote>
<p>crontab -e //编辑某个用户的cron服务 //这个最重要，自己编写crontab</p>
</blockquote>
<blockquote>
<p>crontab -l //列出某个用户cron服务的详细内容//这个也重要，查看自己写了哪些定时任务</p>
</blockquote>
<blockquote>
<p>crontab -u //设定某个用户的cron服务，一般root用户在执行这个命令的时候需要此参数</p>
</blockquote>
<blockquote>
<p>crontab -r //删除某个用户的cron服务</p>
</blockquote>
</div><div class="tags"><a href="/tag/Nginx/"><i class="fa fa-tag"></i>Nginx</a></div><div class="post-nav"><a class="pre" href="/2020/08/20/Nginx%E7%95%AA%E5%A4%96-%E7%AE%80%E5%8D%95%E7%9A%84%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/">Nginx番外-简单的配置详解</a><a class="next" href="/2020/07/16/Nginx%E4%B8%BB%E8%A6%81%E5%BA%94%E7%94%A8-%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA/">Nginx主要应用 - 虚拟主机</a></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/category/Nginx/">Nginx</a><span class="category-list-count">11</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tag/%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86/" style="font-size: 15px;">静态代理</a> <a href="/tag/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" style="font-size: 15px;">负载均衡</a> <a href="/tag/%E9%9D%99%E6%80%81%E7%BD%91%E7%AB%99/" style="font-size: 15px;">静态网站</a> <a href="/tag/%E9%85%8D%E7%BD%AE/" style="font-size: 15px;">配置</a> <a href="/tag/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tag/%E7%AE%80%E4%BB%8B/" style="font-size: 15px;">简介</a> <a href="/tag/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 15px;">环境搭建</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/08/20/Nginx%E7%95%AA%E5%A4%96-%E7%AE%80%E5%8D%95%E7%9A%84%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/">Nginx番外-简单的配置详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/03/Nginx%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-%E6%97%A5%E5%BF%97%E8%87%AA%E5%8A%A8%E5%A4%87%E4%BB%BD/">Nginx日志管理 & 日志自动备份</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/16/Nginx%E4%B8%BB%E8%A6%81%E5%BA%94%E7%94%A8-%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA/">Nginx主要应用 - 虚拟主机</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/16/Nginx%E4%B8%BB%E8%A6%81%E5%BA%94%E7%94%A8-%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/">Nginx主要应用 - 动静分离</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/30/Nginx%E4%B8%BB%E8%A6%81%E5%BA%94%E7%94%A8-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86/">Nginx主要应用 - 静态代理</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/29/Nginx%E4%B8%BB%E8%A6%81%E5%BA%94%E7%94%A8-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">Nginx主要应用 - 负载均衡</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/22/Nginx%E4%B8%BB%E8%A6%81%E5%BA%94%E7%94%A8-%E9%9D%99%E6%80%81%E7%BD%91%E7%AB%99/">Nginx主要应用 - 静态网站</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/19/Nginx%E4%B8%BB%E8%A6%81%E5%BA%94%E7%94%A8/">Nginx主要应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/18/Ngxin%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/">Ngxin配置文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/17/Nginx%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">Nginx环境搭建</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/Sean-inoubliable" title="--- GitHub of Sean ---" target="_blank">--- GitHub of Sean ---</a><ul></ul><a href="https://gitee.com/Sean-inoubliable" title="--- Gitee of Sean ---" target="_blank">--- Gitee of Sean ---</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Sean's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>